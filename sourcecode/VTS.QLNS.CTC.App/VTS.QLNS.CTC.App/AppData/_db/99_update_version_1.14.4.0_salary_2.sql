DELETE FROM [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104]
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'e31f4023-a4b9-4266-9e0c-0f05f16f6f46', 1, N'B1', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 1', CAST(5000000.00 AS Numeric(15, 2)), CAST(0.00 AS Numeric(15, 2)), CAST(5.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'c8ad7aa0-33a8-4c55-ab15-5156a310cc1e', 0, N'B6', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 6', CAST(960000000.00 AS Numeric(15, 2)), CAST(624000000.00 AS Numeric(15, 2)), CAST(30.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'92dafb50-8852-4b19-9de9-6a959a0ea287', 0, N'B3', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 3', CAST(216000000.00 AS Numeric(15, 2)), CAST(120000000.00 AS Numeric(15, 2)), CAST(15.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'8ea20a9f-6af1-4fe7-be20-6bc41967aaa4', 0, N'B5', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 5', CAST(624000000.00 AS Numeric(15, 2)), CAST(384000000.00 AS Numeric(15, 2)), CAST(25.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'be94559c-4c44-4d43-bd6a-745ec8255bd9', 1, N'B2', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 2', CAST(10000000.00 AS Numeric(15, 2)), CAST(5000000.00 AS Numeric(15, 2)), CAST(10.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'c3e3c6b2-ced9-4cea-b730-878fbea01475', 1, N'B4', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 4', CAST(32000000.00 AS Numeric(15, 2)), CAST(18000000.00 AS Numeric(15, 2)), CAST(20.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'3a11d82f-b5c4-4875-b3bf-9a94e0b60354', 0, N'B1', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 1', CAST(60000000.00 AS Numeric(15, 2)), CAST(0.00 AS Numeric(15, 2)), CAST(5.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'dc4d136c-9659-437d-95b0-ad359a5e1e66', 0, N'B7', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 7', CAST(0.00 AS Numeric(15, 2)), CAST(960000000.00 AS Numeric(15, 2)), CAST(35.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'8ecd19b3-1351-4616-8aac-b3b626ef43f2', 0, N'B2', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 2', CAST(120000000.00 AS Numeric(15, 2)), CAST(60000000.00 AS Numeric(15, 2)), CAST(10.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'0c5bc6d7-cd67-4740-970f-b7859bcd3482', 1, N'B5', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 5', CAST(52000000.00 AS Numeric(15, 2)), CAST(32000000.00 AS Numeric(15, 2)), CAST(25.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'401e890f-bdbb-4abe-bc45-d5cd42cd96ed', 1, N'B6', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 6', CAST(80000000.00 AS Numeric(15, 2)), CAST(52000000.00 AS Numeric(15, 2)), CAST(30.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'f7d3e109-7b9d-4ede-888f-db44d1aae446', 0, N'B4', NULL, NULL, NULL, N'Thu nhập tính thuế năm bậc 4', CAST(384000000.00 AS Numeric(15, 2)), CAST(216000000.00 AS Numeric(15, 2)), CAST(20.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'78a73145-c0fd-4f98-a0ca-e3cd3f99ec4c', 1, N'B3', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 3', CAST(18000000.00 AS Numeric(15, 2)), CAST(10000000.00 AS Numeric(15, 2)), CAST(15.00 AS Numeric(5, 2)))
GO
INSERT [dbo].[TL_DM_ThueThuNhapCaNhan_NQ104] ([Id], [bIsThueThang], [Loai_Thue], [Name], [Readonly], [Splits], [Ten_Thue], [ThuNhap_Den], [ThuNhap_Tu], [Thue_Xuat]) VALUES (N'bfc7705f-d3fd-491e-81cd-ef39d828ae11', 1, N'B7', NULL, NULL, NULL, N'Thu nhập tính thuế tháng bậc 7', CAST(320000000.00 AS Numeric(15, 2)), CAST(80000000.00 AS Numeric(15, 2)), CAST(35.00 AS Numeric(5, 2)))
GO


/****** Object:  StoredProcedure [dbo].[sp_tl_rpt_bangthanhtoan_luongthang_2_nq104]    Script Date: 5/3/2024 11:10:20 AM ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_tl_rpt_bangthanhtoan_luongthang_2_nq104]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[sp_tl_rpt_bangthanhtoan_luongthang_2_nq104]
GO
/****** Object:  StoredProcedure [dbo].[sp_tl_rpt_bangthanhtoan_luongthang_2_nq104]    Script Date: 5/3/2024 11:10:20 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_tl_rpt_bangthanhtoan_luongthang_2_nq104]
@MaDonVi NVARCHAR(max),
@Thang int,
@Nam AS int,
@IsOrderChucVu AS bit = 0,
@IsGiaTriAm AS bit = 0,
@IsCheckedMaHuongLuong AS bit = 0
AS
BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;

DECLARE @Cols AS NVARCHAR(MAX)
DECLARE @Query AS NVARCHAR(MAX)

SET @Cols = 'NLCBHT_TT,NLCVCDHT_TT,LCVCDHT_TT,LCBHT_TT,LBLCBHT_TT,LBLCVCDHT_TT,PCCLKHAC_SUM,NTN,LHT_HS,PCTNVK_HS,HSBL_HS,LHT_TT,PCTNVK_TT,HSBL_TT,PCCV_TT,PCTN_TT,PCKV_TT,PCTRA_SUM,PCCOV_TT,PCDACTHU_SUM,PCKHAC_SUM,LUONGTHANG_SUM,BHCN_TT,THUETNCN_TT,TA_TT,GTKHAC_TT,TRICHLUONG_TT,PHAITRU_SUM,TM,THANHTIEN,BHXHCN_TT,BHYTCN_TT,BHTNCN_TT,PCTAUBP_TT,PCBVBG_TT,PCTEMTHU_TT,TA_TONG,PHAITRUKHAC_SUM,LUONGCOBAN_SUM'
SET @Query =
'
WITH BangLuongThang AS (
SELECT Thang, Nam, MaCanBo, ' + @Cols + ' FROM (
SELECT
dsCapNhapBangLuong.Thang AS Thang,
dsCapNhapBangLuong.Nam AS Nam,
bangLuong.Ma_Can_Bo AS MaCanBo,
bangLuong.MA_PHU_CAP AS MaPhuCap,
bangLuong.GIA_TRI AS GiaTri
FROM TL_BangLuong_Thang_Bridge_NQ104 bangLuong
JOIN TL_DS_CapNhap_BangLuong_NQ104 dsCapNhapBangLuong
ON bangLuong.parent = dsCapNhapBangLuong.Id
WHERE
bangLuong.Ma_Phu_Cap IN (SELECT * FROM f_split(''' + @Cols + '''))
AND dsCapNhapBangLuong.Ma_CachTL=''CACH0''
AND dsCapNhapBangLuong.Ma_CBo IN (SELECT * FROM f_split(''' + @MaDonVi + '''))
AND dsCapNhapBangLuong.Thang=' + CAST(@Thang AS VARCHAR(2)) + '
AND dsCapNhapBangLuong.Nam=' + CAST(@Nam AS VARCHAR(4)) + '
AND dsCapNhapBangLuong.Status=1
) x
PIVOT
(
SUM(GiaTri)
FOR MaPhuCap IN (' + @Cols + ')
) pvt
), ThongTinCanBo AS (
SELECT
donVi.Ma_DonVi AS MaDonVi,
donVi.Ten_Donvi AS TenDonvi,
canBo.Ma_CanBo AS MaCanBo,
canBo.Ten_CanBo AS TenCanBo,
loaiNhom.ten_loai TenLoai,
loaiNhom.ten_nhom TenNhom,
capBacLuong.ten_dm CapBacLuong,
canBo.lan_nang_luong_cb LanNangLuongCb,
canBo.lan_nang_luong_cvd LanNangLuongCvd,
dbo.f_split_empty(canbo.Ten_CanBo) AS Ten,
canBo.Thang_TNN AS Tnn,
ISNULL(canBo.Ma_CB104, ''0'') AS MaCapBac,
ISNULL(capBac.Ten_Cb, ''0'') AS CapBac,
chucVu.Ma AS MaChucVu,
chucVu.Ten AS TenChucVu,
CASE WHEN 1 = ' + CAST(@IsCheckedMaHuongLuong AS VARCHAR(10)) + ' THEN CONCAT(canBo.So_TaiKhoan, '' '', canBo.Ma_CanBo) ELSE canBo.So_TaiKhoan END AS Stk,
ISNULL(FORMAT(canBo.Ngay_NN,''MM/yy''), '''') AS NgayNhapNgu,
ISNULL(FORMAT(canBo.Ngay_XN,''MM/yy''), '''') AS NgayXuatNgu,
ISNULL(FORMAT(canBo.Ngay_TN,''MM/yy''), '''') AS NgayTaiNgu,
capBac.Xau_Noi_Ma XauNoiMa
FROM TL_DM_CanBo_NQ104 canBo
INNER JOIN TL_DM_DonVi_NQ104 donVi
ON canBo.Parent=donVi.Ma_DonVi
LEFT JOIN TL_DM_CapBac_NQ104 capBac
ON canBo.Ma_CB104 = capBac.Ma_Cb
LEFT JOIN (SELECT
	con.ten_dm ten_loai,
	con.ma_dm loai,
	chau.ten_dm ten_nhom,
	chau.ma_dm nhom,
	cha.loai_doi_tuong loai_doi_tuong,
	chau.xau_noi_ma
FROM TL_DM_CapBac_Luong_NQ104 cha
LEFT JOIN TL_DM_CapBac_Luong_NQ104 con
ON cha.ma_dm = con.ma_dm_cha 
AND cha.loai_doi_tuong = con.loai_doi_tuong 
AND con.xau_noi_ma like cha.xau_noi_ma + ''-%''
AND con.nam = cha.nam
LEFT JOIN TL_DM_CapBac_Luong_NQ104 chau
ON con.ma_dm = chau.ma_dm_cha 
AND con.loai_doi_tuong = chau.loai_doi_tuong 
AND chau.xau_noi_ma like con.xau_noi_ma + ''-%''
AND chau.nam = con.nam
WHERE cha.loai = 0 AND con.loai = 1 AND chau.loai = 2) loaiNhom
ON loaiNhom.loai = canBo.loai AND loaiNhom.nhom = canBo.nhom_chuyen_mon 
AND canBo.loai_doi_tuong in (select * from f_split(loaiNhom.loai_doi_tuong))

LEFT JOIN (SELECT * FROM TL_DM_CapBac_Luong_NQ104 WHERE loai = 3 and nam = ' + CAST(@Nam AS VARCHAR(4)) + ') capBacLuong
ON (
	(
	canBo.loai_doi_tuong IN (''1'',''3.2'',''4'',''5'') 
	AND canBo.loai_doi_tuong IN 
	(SELECT * FROM f_split(capBacLuong.loai_doi_tuong)) AND capBacLuong.loai_doi_tuong = loaiNhom.loai_doi_tuong
	)
	OR 
	(
	canBo.loai_doi_tuong NOT IN (''1'',''3.2'',''4'',''5'') 
	AND (capBacLuong.ma_dm_cha = loaiNhom.nhom) AND capBacLuong.loai_doi_tuong = loaiNhom.loai_doi_tuong AND capBacLuong.xau_noi_ma like loaiNhom.xau_noi_ma + ''-%''
	)
)
AND capBacLuong.ma_dm = canBo.ma_bac_luong
LEFT JOIN TL_DM_ChucVu_NQ104 chucVu
ON canBo.Ma_Cvd104 = chucVu.Ma AND chucVu.nam = ' + CAST(@Nam AS VARCHAR(4)) + '
WHERE
canBo.IsDelete = 1
AND canBo.Khong_Luong = 0
)

SELECT
bangLuong.*,
canBo.MaDonVi,
canBo.TenDonVi,
canBo.TenCanBo,
canBo.Ten,
canBo.MaCapBac,
canBo.CapBac,
canBo.MaChucVu,
canBo.TenChucVu,
canBo.LanNangLuongCb,
canBo.LanNangLuongCvd,
canBo.TenNhom,
canBo.TenLoai,
canBo.CapBacLuong,
canBo.Stk,
canBo.NgayNhapNgu,
canBo.NgayXuatNgu,
canBo.NgayTaiNgu,
canBo.Tnn,
canBo.XauNoiMa
FROM BangLuongThang bangLuong
INNER JOIN ThongTinCanBo canBo
ON bangLuong.MaCanBo = canBo.MaCanBo'
If @IsGiaTriAm = 1
SET @Query = @Query + ' WHERE bangLuong.THANHTIEN < 0';
IF @IsOrderChucVu = 1
SET @Query = @Query +' ORDER BY MaCapBac DESC, Ten ASC';
ELSE
SET @Query = @Query +' ORDER BY MaCapBac DESC, Ten ASC';
execute(@Query)
END
;
;
;
GO
